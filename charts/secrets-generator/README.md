# secrets-generator

A Helm chart for generating Kubernetes secrets with random values.

## Description

This chart creates one or more Kubernetes secrets with randomly generated values. It's useful for automatically generating passwords, API keys, tokens, and other sensitive data during deployment.

## Features

- Generate multiple secrets in a single chart deployment
- Configure multiple keys per secret
- Support for different character sets (base64, alphanumeric, hex)
- Add prefixes and suffixes to generated values
- Configurable length for each key
- Stable secrets across upgrades (secrets are only generated once)

## Installation

```bash
helm install my-secrets ./secrets-generator -f values.yaml
```

## Configuration

### Basic Example

Create a secret with random values:

```yaml
secrets:
  - name: my-secret
    keys:
      - name: admin-username
        prefix: "admin_"
        length: 6
      - name: admin-password
        length: 32
      - name: password
        length: 32
```

This generates a secret equivalent to:

```bash
kubectl create secret generic my-secret \
  --from-literal=admin-username=admin_$(openssl rand -base64 6) \
  --from-literal=admin-password=$(openssl rand -base64 32) \
  --from-literal=password=$(openssl rand -base64 32)
```

### Multiple Secrets Example

Generate multiple secrets at once:

```yaml
secrets:
  - name: database-credentials
    namespace: production
    keys:
      - name: db-root-password
        length: 32
      - name: db-user-password
        length: 32
  
  - name: api-keys
    namespace: production
    keys:
      - name: admin-api-key
        length: 48
        charset: alphanumeric
      - name: user-api-key
        length: 48
        charset: alphanumeric
```

### Advanced Configuration

```yaml
secrets:
  - name: my-advanced-secret
    namespace: default  # Optional: defaults to release namespace
    type: Opaque  # Optional: defaults to Opaque
    keys:
      - name: username
        prefix: "user_"
        length: 10
        charset: alphanumeric
      
      - name: password
        length: 32
        charset: base64  # Default
      
      - name: api-token
        length: 48
        suffix: "_token"
        charset: hex
      
      - name: pin
        length: 6
        charset: alphanumeric

# Add custom annotations to all secrets
annotations:
  description: "Auto-generated secrets"
  
# Add custom labels to all secrets
labels:
  environment: production
  managed-by: helm
```

## Parameters

### Global Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `secrets` | Array of secret configurations | `[]` |
| `annotations` | Annotations to add to all secrets | `{}` |
| `labels` | Labels to add to all secrets | `{}` |

### Secret Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `name` | Name of the secret (required) | - |
| `namespace` | Namespace for the secret | Release namespace |
| `type` | Type of the secret | `Opaque` |
| `keys` | Array of key configurations (required) | - |

### Key Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `name` | Name of the key in the secret (required) | - |
| `length` | Length of the random value | `32` |
| `prefix` | Prefix to add before the random value | `""` |
| `suffix` | Suffix to add after the random value | `""` |
| `charset` | Character set for generation: `base64`, `alphanumeric`, or `hex` | `base64` |

## Character Sets

- **base64**: Uses base64-encoded random alphanumeric characters (default)
- **alphanumeric**: Uses only letters and numbers (A-Z, a-z, 0-9)
- **hex**: Uses hexadecimal characters (0-9, a-f)

## Usage Tips

### Retrieving Secret Values

After installation, retrieve the generated values:

```bash
# Get the entire secret
kubectl get secret my-secret -o yaml

# Decode a specific key
kubectl get secret my-secret -o jsonpath='{.data.admin-password}' | base64 -d
```

### Stable Secrets

Secrets generated by this chart are stable across Helm upgrades. The random values are only generated during the initial `helm install`. Subsequent `helm upgrade` operations will not change the secret values.

### Regenerating Secrets

To regenerate secrets:

1. Delete the existing secret:
   ```bash
   kubectl delete secret my-secret
   ```

2. Upgrade the Helm release:
   ```bash
   helm upgrade my-secrets ./secrets-generator -f values.yaml
   ```

### Using with Other Charts

This chart can be used as a dependency in other charts or deployed separately to generate secrets that other applications consume.

Example `Chart.yaml` dependency:

```yaml
dependencies:
  - name: secrets-generator
    version: "0.1.0"
    repository: "file://../secrets-generator"
```

## Examples

### Nextcloud Credentials

```yaml
secrets:
  - name: nextcloud-sealed-secrets
    keys:
      - name: admin-username
        prefix: "admin_"
        length: 6
      - name: admin-password
        length: 32
      - name: password
        length: 32
```

### Database Passwords

```yaml
secrets:
  - name: mariadb-passwords
    keys:
      - name: mariadb-root-password
        length: 32
      - name: mariadb-password
        length: 32
      - name: mariadb-replication-password
        length: 32
```

### API Keys

```yaml
secrets:
  - name: api-credentials
    keys:
      - name: admin-api-key
        length: 48
        charset: alphanumeric
      - name: webhook-secret
        length: 64
        charset: hex
```

## Security Considerations

- Secrets are stored in Kubernetes as base64-encoded values (standard Kubernetes secret behavior)
- For production environments, consider using sealed-secrets, external-secrets, or a secrets management solution like Vault
- The generated secrets are deterministic per installation - they won't change on upgrade unless the secret is deleted
- Ensure proper RBAC policies are in place to restrict access to secrets

## Troubleshooting

### Secrets not being created

Verify your values.yaml configuration:

```bash
helm template my-secrets ./secrets-generator -f values.yaml
```

### Need to change secret length

Update your values.yaml and perform a delete + upgrade:

```bash
kubectl delete secret my-secret
helm upgrade my-secrets ./secrets-generator -f values.yaml
```

## License

This chart is provided as-is for use with the grommunio project.

## Contributing

Contributions are welcome! Please submit issues and pull requests to the repository.