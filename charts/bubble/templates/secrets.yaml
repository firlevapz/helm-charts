{{- $backendSecretName := printf "%s-backend" (include "bubble.fullname" .) -}}
{{- $backendSecret := (lookup "v1" "Secret" .Release.Namespace $backendSecretName) -}}
{{- $secretKey := .Values.backend.secrets.secretKey -}}
{{- if not $secretKey -}}
  {{- if and $backendSecret $backendSecret.data (index $backendSecret.data "DJANGO_SECRET_KEY") -}}
    {{- $secretKey = (index $backendSecret.data "DJANGO_SECRET_KEY") | b64dec -}}
  {{- else -}}
    {{- $secretKey = randAlphaNum 64 -}}
  {{- end -}}
{{- end -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $backendSecretName }}
  labels:
    {{- include "bubble.labels" . | nindent 4 }}
type: Opaque
stringData:
  DJANGO_SECRET_KEY: {{ $secretKey | quote }}
  GEMINI_API_KEY: {{ .Values.backend.secrets.geminiApiKey | default "not_set" | quote }}
  MAILGUN_API_KEY: {{ .Values.backend.secrets.mailgunApiKey | default "not_set" | quote }}
  MAILGUN_DOMAIN: {{ .Values.backend.secrets.mailgunDomain | default "not_set" | quote }}
---
{{- if .Values.postgresql.enabled }}
{{- $secretName := printf "%s-postgresql" (include "bubble.fullname" .) -}}
{{- $secret := (lookup "v1" "Secret" .Release.Namespace $secretName) -}}
{{- $password := .Values.postgresql.auth.password -}}
{{- if not $password -}}
  {{- if and $secret $secret.data (index $secret.data "password") -}}
    {{- $password = (index $secret.data "password") | b64dec -}}
  {{- else -}}
    {{- $password = randAlphaNum 16 -}}
  {{- end -}}
{{- end -}}
{{- $postgresPassword := .Values.postgresql.auth.postgresPassword -}}
{{- if not $postgresPassword -}}
  {{- if and $secret $secret.data (index $secret.data "postgres-password") -}}
    {{- $postgresPassword = (index $secret.data "postgres-password") | b64dec -}}
  {{- else -}}
    {{- $postgresPassword = randAlphaNum 16 -}}
  {{- end -}}
{{- end -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    {{- include "bubble.labels" . | nindent 4 }}
type: Opaque
stringData:
  password: {{ $password | quote }}
  postgres-password: {{ $postgresPassword | quote }}
  POSTGRES_USER: {{ .Values.postgresql.auth.username | quote }}
  POSTGRES_PASSWORD: {{ $password | quote }}
  POSTGRES_DB: {{ .Values.postgresql.auth.database | quote }}
{{- end }}
---
{{- if and (not .Values.postgresql.enabled) (not .Values.externalPostgresql.existingSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "bubble.fullname" . }}-external-postgresql
  labels:
    {{- include "bubble.labels" . | nindent 4 }}
type: Opaque
stringData:
  password: {{ .Values.externalPostgresql.password | quote }}
{{- end }}
---
{{- if and (not .Values.redis.enabled) .Values.externalRedis.password (not .Values.externalRedis.existingSecret) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "bubble.fullname" . }}-external-redis
  labels:
    {{- include "bubble.labels" . | nindent 4 }}
type: Opaque
stringData:
  password: {{ .Values.externalRedis.password | quote }}
{{- end }}
